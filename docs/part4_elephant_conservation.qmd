---
title: "Part4: Elephant conservation analysis"
author: "Lei Song"
editor: visual
toc: true
toc-depth: 2
number-sections: false
toc-location: left
output: 
  html:
      theme: journal
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)

# Load libraries
library(here)
library(sf)
library(dplyr)
library(terra)
select <- dplyr::select

# Define paths
data_dir <- here("data")
ele_data_dir <- here("data/elephant")
rlt_dir <- here("results")
trdeoff_dir <- here("data/tradeoff")
```

## Introduction

This part works together with biodiversity cost analysis to evaluate conservation. We separated elephant conservation from biodiversity to highlight the importance of this keystone species. The analysis includes two parts:

-   Environmental suitability
-   Landscape connectivity

## Environmental suitability

We directly used the environmental suitability map generated in the previous study.

```{r}
fname <- file.path(ele_data_dir, "landscape_utility_1km_integrated.tif")
suitability <- rast(fname)[["prediction"]]

# Write out asc file
suitability[is.na(suitability)] <- -9999
writeRaster(suitability, file.path(ele_data_dir, 'suitability.asc'),
            wopt = list(NAflag = -9999))
```

## Clean the protected areas

In order to simulate landscape connectivity, we used census blocs=ks as the nodes in circuitscape. However, not all protected areas can be used by elephants, which are mega creatures. Other protected areas still can be used by elephants for migration in the simulation.

```{r}
pas <- read_sf(file.path(ele_data_dir, "census.geojson"))
```

## Landscape connectivity

In this step, we used circuitscape to simulate the landscape connectivity. We used 50% randomly selected blocks as nodes, and suitability as conductance in circuitscape. Then we ran 50 simulations and aggregate the results to represent the final landscape connectivity.

    cd /path/to/comTCA
    Rscript scripts/circuit_sim.R -n 50

## Merge two layers

We used the geometric mean of suitability and connectivity.

```{r}
fname <- file.path(ele_data_dir, "landscape_utility_1km_integrated.tif")
suitability <- rast(fname)[["prediction"]]

connectivity <- rast(file.path(ele_data_dir, "mean_curmap.tif"))
# connectivity <- stretch(connectivity, minv = 0, maxv = 1)
# ele_conserv <- sqrt(suitability * connectivity)
ele_conserv <- stretch(
    connectivity, minv = 0, maxv = 1, 
    minq = 0.1, maxq = 0.99)

# Write out
writeRaster(
    ele_conserv, file.path(trdeoff_dir, "elephant_conservation_index.tif"),
    overwrite = TRUE)
```
